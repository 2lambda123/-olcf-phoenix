#!/usr/bin/env python
"""Phoenix power control"""
# vim: tabstop=4 shiftwidth=4 softtabstop=4

import sys
import argparse
import logging
from ClusterShell.NodeSet import NodeSet
import phoenix
import phoenix.Parallel
from phoenix.Node import Node

def get_parser():
	parser = argparse.ArgumentParser(prog="phoenix_power", description="Control the power of Phoenix nodes")
	parser.add_argument('nodes', default=None, type=str, help='Nodes to list')
        parser.add_argument('action', default=None, type=str, help='Action')
        parser.add_argument('arguments', nargs='?')
	parser.add_argument('-v', '--verbose', action='count', default=0)
        parser.add_argument('-f', '--fanout', type=int, default=64, help='Fanout value')
        parser.add_argument('-t', '--command-timeout', type=int, default=0)
        parser.add_argument('-T', '--connect-timeout', type=int, default=20)
	return parser

if __name__ == '__main__':
	parser = get_parser()
	args = parser.parse_args()

	phoenix.setup_logging(args.verbose)

	nodes = NodeSet(args.nodes)

        (task, handler) = phoenix.Parallel.setup(nodes, args)
        task.shell(["power"] + [args.action] + [args.arguments], nodes=nodes, handler=handler, autoclose=False)
        task.resume()

	sys.exit(0)
