#!/usr/bin/env python
"""Phoenix configuration"""
# vim: tabstop=4 expandtab shiftwidth=4 softtabstop=4

import sys
import argparse
import logging
from ClusterShell.NodeSet import NodeSet
import phoenix
from phoenix.bootloader import write_bootloader_scripts
from phoenix.node import Node
from phoenix.system import System
from phoenix.dhcp import load_dhcp_provider

def get_parser():
    parser = argparse.ArgumentParser(description="Phoenix configuration utility")
    parser.add_argument('-v', '--verbose', action='count', default=0)
    subparsers = parser.add_subparsers(help='sub-command help', dest='action')
    parser_hosts = subparsers.add_parser('hosts', help='hosts help')

    parser_dhcp = subparsers.add_parser('dhcp', help='dhcp help')
    parser_updatedhcp = subparsers.add_parser('updatedhcp', help='update dhcp help')

    parser_bootfile = subparsers.add_parser('bootfiles', help='bootfile help')

    parser_ethers = subparsers.add_parser('ethers', help='ethers help')

    return parser

if __name__ == '__main__':
    parser = get_parser()
    args = parser.parse_args()

    phoenix.setup_logging(args.verbose)
    Node.load_nodes()

    if args.action == 'hosts':
        System.load_config()
        for nodename,node in sorted(Node.nodes.items()):
            if 'interfaces' in node:
                for ifacename, iface in node['interfaces'].items():
                    if 'ip' not in iface:
                        continue
                    hostname = iface['hostname'] if 'hostname' in iface else nodename
                    print "%s\t%s\t%s.%s" % (iface['ip'], hostname, hostname, System.config['domain'])
    elif args.action == 'bootfiles':
        write_bootloader_scripts()
    elif args.action == 'dhcp':
        provider = load_dhcp_provider()
        print provider.get_dhcp_conf()
    elif args.action == 'updatedhcp':
        provider = load_dhcp_provider()
        provider.update_dhcp_reservations()
    elif args.action == 'ethers':
        for nodename,node in sorted(Node.nodes.items()):
            if 'hsnmac' in node:
                print "%s\t%s" % (node['hsnmac'], nodename + 'h0')

    rc = 0

    sys.exit(rc)
