#!/usr/bin/env python
"""Phoenix configuration"""
# vim: tabstop=4 expandtab shiftwidth=4 softtabstop=4

import sys
import argparse
import logging
from ClusterShell.NodeSet import NodeSet
import phoenix
from phoenix.bootloader import write_bootloader_scripts
from phoenix.node import Node
from phoenix.system import System
from phoenix.dhcp import load_dhcp_provider

def get_parser():
    parser = argparse.ArgumentParser(description="Phoenix configuration utility")
    parser.add_argument('-v', '--verbose', action='count', default=0)
    subparsers = parser.add_subparsers(help='sub-command help', dest='action')
    parser_hosts = subparsers.add_parser('hosts', help='hosts help')

    parser_dhcp = subparsers.add_parser('dhcp', help='dhcp help')
    parser_updatedhcp = subparsers.add_parser('updatedhcp', help='update dhcp help')

    parser_bootfile = subparsers.add_parser('bootfiles', help='bootfile help')

    parser_ethers = subparsers.add_parser('ethers', help='ethers help')

    parser_hpcm = subparsers.add_parser('hpcm', help='hpcm help')

    return parser

if __name__ == '__main__':
    parser = get_parser()
    args = parser.parse_args()

    phoenix.setup_logging(args.verbose)
    Node.load_nodes()

    if args.action == 'hosts':
        System.load_config()
        for nodename,node in sorted(Node.nodes.items()):
            if 'interfaces' in node:
                for ifacename, iface in node['interfaces'].items():
                    if 'ip' not in iface:
                        continue
                    hostname = iface['hostname'] if 'hostname' in iface else nodename
                    print "%s\t%s\t%s.%s" % (iface['ip'], hostname, hostname, System.config['domain'])
    elif args.action == 'bootfiles':
        write_bootloader_scripts()
    elif args.action == 'dhcp':
        provider = load_dhcp_provider()
        print provider.get_dhcp_conf()
    elif args.action == 'updatedhcp':
        provider = load_dhcp_provider()
        provider.update_dhcp_reservations()
    elif args.action == 'ethers':
        for nodename,node in sorted(Node.nodes.items()):
            if 'interfaces' not in node:
                logging.debug("No interfaces defined for node %s, skipping", nodename)
                continue
            for interface in node['interfaces']:
                iface = node['interfaces'][interface]
                if 'dhcp' not in iface or not iface['dhcp']:
                    logging.debug("Skipping % interface %s because DHCP is not set", nodename, interface)
                    continue
                if 'hostname' not in iface:
                    iface['hostname'] = nodename
                print "%s\t%s" % (iface['mac'], iface['hostname'])
    elif args.action == 'hpcm':
        print("[discover]")
        for node in NodeSet('@nc'):
            n = Node.find_node(node)
            print("internal_name={name},hostname1={name},mgmt_bmc_net_macs=\"{mac}\",mgmt_bmc_net_name=hostctrl3000,rack_nr={rack},chassis={chassis},tray={slot},cmm_parent={pdu},username=root,password=initial0,node_controller".format(name=n['name'], mac=n['interfaces']['me0']['mac'], rack=n['racknum'], chassis=n['chassis'], slot=n['slot'], pdu=n['pdu']))
        servicenum=600
        for node in NodeSet('@compute'):
            n = Node.find_node(node)
            print("internal_name=service{servicenum},mgmt_net_macs=\"{mac}\",mgmt_net_name=hostmgmt2000,rack_nr={rack},chassis={chassis},tray={slot},node_nr={nodenum},controller_nr={board},hostname1={name},node_controller={bmc},network_group=rack{rack},console_device=ttyS0,conserver_logging=yes,rootfs=nfs,nfs_writable_type=tmpfs-overlay,transport=rsync,mgmt_net_bonding_master=bond0,dhcp_bootfile=ipxe-direct,mgmt_net_interfaces=\"enp65s0\",baud_rate=115200,image={image}".format(name=n['name'], mac=n['interfaces']['eth0']['mac'], rack=n['racknum'], chassis=n['chassis'], slot=n['slot'], board=n['board'], nodenum=n['nodenum'], bmc=n['bmc'], servicenum=servicenum, image=n['image']))
            servicenum = servicenum + 1

    rc = 0

    sys.exit(rc)
